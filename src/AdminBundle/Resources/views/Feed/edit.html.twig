{% extends 'AdminBundle::base.html.twig' %}

{% block stylesheets %}
  {{ parent() }}
  <link rel="stylesheet" href="{{ asset('assets/node_modules/jsoneditor/dist/jsoneditor.min.css') }}">
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script src="{{ asset('assets/node_modules/jsoneditor/dist/jsoneditor.min.js') }}"/></script>

  <script>
   var schema = {
     "title": "Feed",
     "type": "object",
     "properties": {
       "url": {
         "type": "string"
       },
       "type": {
         "enum": ["json", "xml"]
       },
       "root": {
         "type": "string"
       },
       "occurrenceRoot": {
         "type": "string"
       },
       "baseUrl": {
         "type": "string"
       },
       "mapping": { "$ref": "#/definitions/mapping" },
       "defaults": {
       },
     },
     "required": ["url", "type"],
     "additionalProperties": false,

     "definitions": {
       "mapping": {
         "type": "object",
         "properties": {
           "id": { "$ref": "#/definitions/mappedField" },
           "name": { "$ref": "#/definitions/mappedField" },
           "url": { "$ref": "#/definitions/mappedField" },
           "occurrences": {
             "type": "object",
             "properties": {
               "path": { "type": "string" },
               "mapping": {
                 "type": "object",
                 "properties": {
                   "startDate": { "$ref": "#/definitions/mappedField" },
                   "endDate": { "$ref": "#/definitions/mappedField" },
                   "venue": { "$ref": "#/definitions/mappedField" },
                 },
                 "required": [ "startDate", "endDate" ]
               }
             }
           }
         },
         "required": [ "id", "name", "occurrences" ]
       },

       "mappedField": {
         "oneOf": [
           {
             "type": "string"
           },
           {
             "type": "object",
             "properties": {
               "path": { "type": "string" }
             },
             "required": [ "path" ]
           }
         ]
       }
     }
   };

   var el = document.getElementById('{{ edit_form.configuration.vars.id }}')
   el.type = 'hidden';

   var container = document.createElement('div');
   el.parentNode.insertBefore(container, el);

   var json = JSON.parse(el.value);

   var options = {
     schema: schema,
     modes: [ 'tree', 'view', 'form', 'code', 'text' ],
     onChange: function() {
       try {
         el.value = JSON.stringify(editor.get());
       } catch (ex) {}
     }
   };

   // create the editor
   var editor = new JSONEditor(container, options, json);
   editor.expandAll();
  </script>
{% endblock %}

{% block body -%}
  <h1>Feed edit</h1>

  {{ form(edit_form) }}

  <div id="jsoneditor"></div>

  <ul class="record_actions">
    <li>
      <a href="{{ path('admin_feed') }}">
        Back to the list
      </a>
    </li>
    <li>{{ form(delete_form) }}</li>
  </ul>
{% endblock %}
